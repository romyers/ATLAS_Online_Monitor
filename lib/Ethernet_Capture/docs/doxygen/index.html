<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DAQCap: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DAQCap
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Data capture library for the miniDAQ system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">DAQCap Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md0">DAQCap &ndash; ATLAS MiniDAQ Data Capture Library</a><ul><li class="level2"><a href="#autotoc_md1">Setup</a><ul><li class="level3"><a href="#autotoc_md2">Manual Installation</a></li>
<li class="level3"><a href="#autotoc_md3">Build with Installer</a></li>
<li class="level3"><a href="#autotoc_md4">Install with FetchContent</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md5">Usage</a></li>
<li class="level2"><a href="#autotoc_md6">Documentation</a></li>
<li class="level2"><a href="#autotoc_md7">Example: Reading Data</a></li>
<li class="level2"><a href="#autotoc_md8">For Developers</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>TODO: pthread linking</p>
<h1><a class="anchor" id="autotoc_md0"></a>
DAQCap â€“ ATLAS MiniDAQ Data Capture Library</h1>
<p>This library provides tools for capturing data from miniDAQ MDT and sMDT chambers via an ethernet connection, together with an optional executable program that captures miniDAQ data and writes it to a DAT file.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Setup</h2>
<p>This library was developed for Linux, and requires C++11 support or better. Windows and MacOS environments have not been tested.</p>
<p>DAQCap is based on <a href="https://github.com/the-tcpdump-group/libpcap/tree/master">libpcap</a>, and expects libpcap version 1.10.0 or later. Earlier versions may work, but some functionality (e.g. <a class="el" href="classDAQCap_1_1SessionHandler.html#a3af6bfd3134470ff5079c9595f48f5c4" title="Thread-safe method that interrupts calls to fetchData().">DAQCap::SessionHandler::interrupt()</a>) may not work as intended.</p>
<p>If libpcap is not present, it will be installed during the build process. Installing libpcap requires:</p><ul>
<li><a href="https://github.com/westes/flex">Flex</a> version 2.5.31 or later.</li>
<li><p class="startli">One of:</p><ul>
<li><a href="https://ftp.gnu.org/gnu/bison/">Bison</a></li>
<li><a href="https://ftp.gnu.org/gnu/bison/">Berkely YACC</a></li>
</ul>
<p class="startli">or another compatible version of YACC.</p>
</li>
</ul>
<p>Once either libpcap or its prerequisites are included, download and build the DAQCap library either <a href="#manual-installation">manually</a>, with the included <a href="#build-with-installer">install script</a>, or with <a href="#install-with-fetchcontent">CMake FetchContent</a>.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
Manual Installation</h3>
<p>Clone the repository and build with CMake: </p><div class="fragment"><div class="line">$ cmake [PATH_TO_SOURCE_DIRECTORY]</div>
<div class="line">$ make</div>
</div><!-- fragment --><p> By default, the library will not be built with tests or the optional executable. To build with tests or the optional executable, run CMake with the <code>BUILD_TESTING</code> or <code>BUILD_EXE</code> options set to <code>ON</code>: </p><div class="fragment"><div class="line">$ cmake -DBUILD_TESTING=ON -DBUILD_EXE=ON [PATH_TO_SOURCE_DIRECTORY]</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md3"></a>
Build with Installer</h3>
<p>Clone the repository, navigate to the project directory, run: </p><div class="fragment"><div class="line">$ source install.sh</div>
</div><!-- fragment --><p> and provide root privileges when prompted.</p>
<p>This will build the library together with the optional executable and install them in a subdirectory of the project directory called 'build'.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Install with FetchContent</h3>
<p>You can easily add this library to a CMake project using the <code>FetchContent</code> module: </p><div class="fragment"><div class="line">include(FetchContent)</div>
<div class="line">FetchContent_Declare(</div>
<div class="line">    DAQCap</div>
<div class="line">    GIT_REPOSITORY https://github.com/romyers/DAQCap</div>
<div class="line">    GIT_TAG v1.0 # Or later version</div>
<div class="line">)</div>
<div class="line">FetchContent_MakeAvailable(DAQCap)</div>
</div><!-- fragment --><p> Then link the library to your target, e.g: </p><div class="fragment"><div class="line">target_link_libraries(my_target PRIVATE DAQCap)</div>
</div><!-- fragment --><p> And include the header in your source files: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="DAQCap_8h.html">DAQCap.h</a>&gt;</span></div>
<div class="ttc" id="aDAQCap_8h_html"><div class="ttname"><a href="DAQCap_8h.html">DAQCap.h</a></div><div class="ttdoc">Main interface for the DAQCap library.</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md5"></a>
Usage</h2>
<p>To use this library, link it to your executable and include the <code><a class="el" href="DAQCap_8h.html" title="Main interface for the DAQCap library.">DAQCap.h</a></code> header in your source files. You may also need to link a threading library, such as pthread. See <a href="../examples/CMakeLists.txt">examples/CMakelists.txt</a> for an example of how to do this.</p>
<p>Any executable using this library on Linux must have CAP_NET_RAW file capabilities: </p><div class="fragment"><div class="line">$ sudo setcap cap_net_raw=eip [EXECUTABLE]</div>
</div><!-- fragment --><p> This includes the optional executable included with DAQCap. If built using the install script, the optional executable will be given this capability automatically.</p>
<p>A full <a href="#example-reading-data">example program</a> is included later in this document. See the <a href="#documentation">documentation section</a> for further information.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Documentation</h2>
<p>The DAQCap library features full API documentation via Doxygen. To build the documentation, navigate to the CMake build directory and run: </p><div class="fragment"><div class="line">$ make docs</div>
</div><!-- fragment --><p> This will generate Doxygen documentation for the public API in the docs/doxygen folder under the project directory.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Example: Reading Data</h2>
<p>The following is a simple program illustrating the use of the DAQCap library: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="DAQCap_8h.html">DAQCap.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// The first step is to create a session handler. Library functionality</span></div>
<div class="line">    <span class="comment">// will be accessed through this handler.</span></div>
<div class="line">    <a class="code" href="classDAQCap_1_1SessionHandler.html">DAQCap::SessionHandler</a> handler;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Next we&#39;ll get a list of available network devices.</span></div>
<div class="line">    std::vector&lt;std::shared_ptr&lt;DAQCap::Device&gt;&gt; devices;</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// This will throw an exception if the device list could not be</span></div>
<div class="line">        <span class="comment">// obtained.</span></div>
<div class="line">        devices = handler.<a class="code" href="classDAQCap_1_1SessionHandler.html#ab09742bde4a6f52e23ca38d9831c1668">getAllNetworkDevices</a>();</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">catch</span>(...) {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Pick a device. We could prompt the user to select a device, or we could</span></div>
<div class="line">    <span class="comment">// accept a device name and use handler.getNetworkDevice([device name])</span></div>
<div class="line">    <span class="comment">// to look for and retrieve the associated device.</span></div>
<div class="line">    std::shared_ptr&lt;DAQCap::Device&gt; d = devices[0];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Next, we&#39;ll start a capture session on the selected device.</span></div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// This too will throw an exception if something goes wrong.</span></div>
<div class="line">        handler.<a class="code" href="classDAQCap_1_1SessionHandler.html#ad6aa267c754113af6ecfb8083a824406">startSession</a>(d);</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">catch</span>(...) {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// We&#39;re now ready to read the data. Loop until we&#39;ve read some number</span></div>
<div class="line">    <span class="comment">// of packets. Here, we&#39;ll store the packet data in a buffer, but we could</span></div>
<div class="line">    <span class="comment">// e.g. write to a file or feed the data to a decoding library instead.</span></div>
<div class="line">    <span class="keywordtype">int</span> packets = 0;</div>
<div class="line">    std::vector&lt;uint8_t&gt; dataBuffer;</div>
<div class="line">    <span class="keywordflow">while</span>(packets &lt; 10000) {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// This will block until packet data is received, then return</span></div>
<div class="line">        <span class="comment">// the data as a DAQData::DataBlob.</span></div>
<div class="line">        <a class="code" href="classDAQCap_1_1DataBlob.html">DAQCap::DataBlob</a> data;</div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            data = handler.<a class="code" href="classDAQCap_1_1SessionHandler.html#a11f690351108be3af22a76b00511032e">fetchData</a>();</div>
<div class="line">        } <span class="keywordflow">catch</span>(...) { <span class="keywordflow">continue</span>; }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Another version of this call, this time specifying a timeout</span></div>
<div class="line">        <span class="comment">// and a maximum number of packets to read. This will try to read</span></div>
<div class="line">        <span class="comment">// at most 50 packets, and throw a DAQCap::timeout_exception</span></div>
<div class="line">        <span class="comment">// if it fails to complete the read within 10 seconds.</span></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">        try {</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">            DAQCap::DataBlob data = handler.fetchData(</span></div>
<div class="line"><span class="comment">                std::chrono::seconds(10),</span></div>
<div class="line"><span class="comment">                50</span></div>
<div class="line"><span class="comment">            );</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">        } catch(const DAQCap::timeout_exception &amp;e) {</span></div>
<div class="line"><span class="comment">        </span></div>
<div class="line"><span class="comment">            continue;</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">        } catch(...) { continue; }</span></div>
<div class="line"><span class="comment">        */</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Let&#39;s report any issues that occurred during the read.</span></div>
<div class="line">        <span class="keywordflow">for</span>(std::string warning : data.<a class="code" href="classDAQCap_1_1DataBlob.html#aaacbcd137a2f80ca13112ceb1fd9ef92">warnings</a>()) {</div>
<div class="line"> </div>
<div class="line">                std::cerr &lt;&lt; warning &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Now we&#39;ll buffer the data using DataBlob&#39;s iterators</span></div>
<div class="line">        dataBuffer.insert(</div>
<div class="line">            dataBuffer.end(),</div>
<div class="line">            data.<a class="code" href="classDAQCap_1_1DataBlob.html#ab0d92423d93232c46633cb40bd20a0bd">cbegin</a>(),</div>
<div class="line">            data.<a class="code" href="classDAQCap_1_1DataBlob.html#aa8591e17832da1b67ad9c847d4bf7d51">cend</a>()</div>
<div class="line">        );</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// And record the packet count</span></div>
<div class="line">        packets += data.<a class="code" href="classDAQCap_1_1DataBlob.html#aeb68d11c7869999afa198a96a98c9def">packetCount</a>();</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclassDAQCap_1_1DataBlob_html"><div class="ttname"><a href="classDAQCap_1_1DataBlob.html">DAQCap::DataBlob</a></div><div class="ttdoc">Represents a blob of data fetched from a network device.</div><div class="ttdef"><b>Definition:</b> DAQBlob.h:47</div></div>
<div class="ttc" id="aclassDAQCap_1_1DataBlob_html_aa8591e17832da1b67ad9c847d4bf7d51"><div class="ttname"><a href="classDAQCap_1_1DataBlob.html#aa8591e17832da1b67ad9c847d4bf7d51">DAQCap::DataBlob::cend</a></div><div class="ttdeci">const_iterator cend() const</div><div class="ttdoc">Returns a const iterator to the end of the data.</div></div>
<div class="ttc" id="aclassDAQCap_1_1DataBlob_html_aaacbcd137a2f80ca13112ceb1fd9ef92"><div class="ttname"><a href="classDAQCap_1_1DataBlob.html#aaacbcd137a2f80ca13112ceb1fd9ef92">DAQCap::DataBlob::warnings</a></div><div class="ttdeci">std::vector&lt; std::string &gt; warnings() const</div><div class="ttdoc">Gets warnings that were generated during the fetch.</div></div>
<div class="ttc" id="aclassDAQCap_1_1DataBlob_html_ab0d92423d93232c46633cb40bd20a0bd"><div class="ttname"><a href="classDAQCap_1_1DataBlob.html#ab0d92423d93232c46633cb40bd20a0bd">DAQCap::DataBlob::cbegin</a></div><div class="ttdeci">const_iterator cbegin() const</div><div class="ttdoc">Returns a const iterator to the beginning of the data.</div></div>
<div class="ttc" id="aclassDAQCap_1_1DataBlob_html_aeb68d11c7869999afa198a96a98c9def"><div class="ttname"><a href="classDAQCap_1_1DataBlob.html#aeb68d11c7869999afa198a96a98c9def">DAQCap::DataBlob::packetCount</a></div><div class="ttdeci">int packetCount() const</div><div class="ttdoc">Gets number of packets in the data blob.</div></div>
<div class="ttc" id="aclassDAQCap_1_1SessionHandler_html"><div class="ttname"><a href="classDAQCap_1_1SessionHandler.html">DAQCap::SessionHandler</a></div><div class="ttdoc">Manages a session with a network device.</div><div class="ttdef"><b>Definition:</b> DAQCap.h:49</div></div>
<div class="ttc" id="aclassDAQCap_1_1SessionHandler_html_a11f690351108be3af22a76b00511032e"><div class="ttname"><a href="classDAQCap_1_1SessionHandler.html#a11f690351108be3af22a76b00511032e">DAQCap::SessionHandler::fetchData</a></div><div class="ttdeci">DataBlob fetchData(std::chrono::milliseconds timeout=FOREVER, int packetsToRead=ALL_PACKETS)</div><div class="ttdoc">Waits for and retrieves data from the network device associated with this SessionHandler.</div></div>
<div class="ttc" id="aclassDAQCap_1_1SessionHandler_html_ab09742bde4a6f52e23ca38d9831c1668"><div class="ttname"><a href="classDAQCap_1_1SessionHandler.html#ab09742bde4a6f52e23ca38d9831c1668">DAQCap::SessionHandler::getAllNetworkDevices</a></div><div class="ttdeci">std::vector&lt; std::shared_ptr&lt; Device &gt; &gt; getAllNetworkDevices()</div><div class="ttdoc">Gets a list of all network devices on the system. If no devices could be found, returns an empty vect...</div></div>
<div class="ttc" id="aclassDAQCap_1_1SessionHandler_html_ad6aa267c754113af6ecfb8083a824406"><div class="ttname"><a href="classDAQCap_1_1SessionHandler.html#ad6aa267c754113af6ecfb8083a824406">DAQCap::SessionHandler::startSession</a></div><div class="ttdeci">void startSession(const std::shared_ptr&lt; Device &gt; device)</div><div class="ttdoc">Begins a capture session on the specified device, and prepares the SessionHandler to fetch data from ...</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
For Developers</h2>
<p>Documentation for the internal DAQCap API is available. To generate it, run: </p><div class="fragment"><div class="line">$ cmake -DBUILD_INTERNAL_DOCS=ON [PATH_TO_SOURCE_DIRECTORY]</div>
<div class="line">$ make docs</div>
</div><!-- fragment --><p>For more information, see the developer notes. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
